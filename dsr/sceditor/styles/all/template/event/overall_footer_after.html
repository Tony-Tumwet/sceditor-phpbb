<!-- IF S_SCEDITOR -->
<!-- INCLUDEJS @dsr_sceditor/js/sceditor/jquery.sceditor.bbcode.min.js -->
<!-- INCLUDEJS @dsr_sceditor/js/sceditor/custom_autosave.js -->

<!-- IF L_SCEDITOR_LANG -->
<!-- INCLUDEJS @dsr_sceditor/js/sceditor/languages/{L_SCEDITOR_LANG}.js -->
<!-- ENDIF -->

<!-- syntax highlight start -->
<!-- INCLUDEJS @dsr_sceditor/js/highlight/highlight.pack.js -->

<script>
    head.ready(function () {
        $('pre code').each(function(i, block) {
            // si no hago este chequeo rompe el tag code original
            if (typeof block === 'object' && block.className !== '') {
                hljs.highlightBlock(block);
            }
        });
    });
</script>
<!-- syntax highlight end -->

<style type="text/css">
    .sceditor-button-custombbcodes div { background: url('{U_TOOLS_IMG}/cog.png'); }
    .sceditor-button-code2 div { background-position: 0 -576px; }
    div.sceditor-dropdown { padding: 5px; }
</style>

<script type="text/javascript">
    var sceFontSizesTexts = {
        "L_FONT_TINY": "{L_FONT_TINY}",
        "L_FONT_SMALL": "{L_FONT_SMALL}",
        "L_FONT_NORMAL": "{L_FONT_NORMAL}",
        "L_FONT_LARGE": "{L_FONT_LARGE}",
        "L_FONT_HUGE": "{L_FONT_HUGE}"
    };

    var sceFontSizes = ['50', '85', '100', '150', '200'];

    // fix use of S_SMILIES_ALLOWED
    var sceEmoticonsBBcode = {
        <!-- BEGIN emoticons -->
            "{emoticons.code|escape('js')}": "{emoticons.url}"<!-- IF !emoticons.S_LAST_ROW -->, <!-- ENDIF -->
        <!-- END emoticons -->
    };

    // fix use of S_BBCODE_ALLOWED
    var sceCustomBBcode = {
        <!-- BEGIN custom_tags -->
            "{custom_tags.BBCODE_TAG|escape('js')}": "{custom_tags.BBCODE_HELPLINE|escape('js')}"<!-- IF !custom_tags.S_LAST_ROW -->, <!-- ENDIF -->
        <!-- END custom_tags -->
    };

    var sceCodeBBcode = {
        dropdown: {
            'bash': 'Bash',
            'cs': 'C#',
            'cpp': 'C/C++',
            'java': 'Java',
            'javascript': 'Javascript',
            'php': 'Php',
            'python': 'Python',
            'sql': 'SQL',
            'shell': 'Shell',
            'autoit': 'Autoit',
            'delphi': 'Delphi',
            'vbnet': 'VB .NET',
            'vbscript': 'VB Script',
        },
        more: {
            'css': 'CSS',
            'diff': 'Diff',
            'go': 'Go',
            'xml': 'Xml',
            'http': 'Http',
            'json': 'JSON',
            'less': 'Less',
            'lua': 'Lua',
            'makefile': 'Makefile',
            'markdown': 'Markdown',
            'nginx': 'Nginx',
            'ruby': 'Ruby',
            'rust': 'Rust',
            'scss': 'Scss',
            'ini': 'INI',
            'typescript': 'Typescript',
            'yaml': 'Yaml',
            'arduino': 'Arduino',
            'basic': 'Basic',
            'dos': 'Dos',
            'dockerfile': 'Dockerfile',
            'powershell': 'Powershell',
        }
    };

    var sceController = (function ($) {
        var _sourceButton,
            _sourceButtonAvailable,
            _textarea,
            _smiliesCheckbox,
            _sourceCheckbox,
            _currentSourceMode,
            _sceInstance,
            _max_fontsize = {MAX_FONTSIZE},
            _lastStyleSheet = { },
            _styleSheets,
            _cssString,
            _cssBase,
            _docroot,
            _fullDocroot,
            _tmp,
            _internalMethods = {
                'sourceMode': function (_active) {
                    // Are we on a page where SCEditor is loaded and used?
                    if ('undefined' === typeof _sceInstance || 'undefined' === typeof _sceInstance.sourceMode) {
                        return null;
                    }
                    if (typeof _active === 'undefined') {
                        return _sceInstance.sourceMode();
                    }
                    _active = !!_active;
                    _sceInstance.sourceMode(_active);
                },
                'sourceButton': {
                    'init': function () {
                        _sourceButton = $('a.sceditor-button-source');
                        _sourceButtonAvailable = !!_sourceButton.length;
                        _sourceCheckbox = $('#disable_bbcode');
                    },
                    'hide': function () {
                        if (_sourceButtonAvailable) {
                            _sourceButton.hide();
                        }
                    },
                    'setOnClick': function () {
                        _sourceCheckbox.on('click', function () {
                            if (_sourceCheckbox.is(':checked')) {
                                // We need this to know if we have to go back to WYSIWYG or not
                                _currentSourceMode = _internalMethods.sourceMode();
                                _internalMethods.sourceMode(true);
                                if (_sourceButtonAvailable) {
                                    _sourceButton.hide();
                                }
                            }
                            else {
                                // Only back to WYSIWYG if it was active before
                                if (!_currentSourceMode) {
                                    _internalMethods.sourceMode(false);
                                }
                                if (_sourceButtonAvailable) {
                                    _sourceButton.show();
                                }
                            }
                        });
                    }
                },
                'getDocroot': function () {
                    if ('undefined' !== typeof _docroot) {
                        return _docroot;
                    }
                    else if ('/' === location.pathname.substr(-1)) {
                        _docroot = location.pathname;
                    }
                    else {
                        _tmp = location.pathname.lastIndexOf('/') + 1;
                        _docroot = location.pathname.substr(0, _tmp);
                    }
                    _fullDocroot = location.protocol + '//' +
                        ('' === location.username ? '' : (location.username + ('' === location.password ? '' : (':' + location.password)) + '@')) +
                        location.hostname + ('' === location.port ? '' : ':' + location.port) + _docroot;

                    return _docroot;
                },
                'emoticons': {
                    'init': function () {
                        _smiliesCheckbox = $('#disable_smilies');
                    },
                    'setOnClick': function () {
                        _smiliesCheckbox.on('click', function () {
                            if (_smiliesCheckbox.is(':checked')) {
                                _sceInstance.emoticons(false);
                            }
                            else {
                                _sceInstance.emoticons(true);
                            }
                        });
                    }
                },
                'css': {
                    'getBase': function (_cssStyleSheet) {
                        // Is this really a CSSStyleSheet object?
                        if (!(_cssStyleSheet instanceof CSSStyleSheet)) {
                            return false;
                        }
                        // Did we parse this StyleSheet already?
                        if (_cssStyleSheet === _lastStyleSheet && !('undefined' === typeof _cssBase)) {
                            return _cssBase;
                        }

                        // Stylesheet directly on the page?
                        if ((null === typeof _cssStyleSheet.href) || (null === _cssStyleSheet.href)) {
                            _tmp = location.href.match(/[^?]+\//);
                        }
                        else {
                            _tmp = _cssStyleSheet.href.match(/[^?]+\//);
                        }

                        _cssBase = _tmp[0];
                        _lastStyleSheet = _cssStyleSheet;

                        return _cssBase;
                    },
                    'realpath': function (_path) {
                        /**
                         *  I dont use
                         *  if (-1 !== $.inArray(0, [path.indexOf('/'), path.indexOf('http://'), path.indexOf('https://'), path.length])) {
                         *  because all indexOf and the length have to be calculated before the check starts.
                         *  The "normal" version is faster.
                         */
                        // Do we really have to do something?
                        if (0 === _path.length) {
                            // No path info.. nothing to do
                            return _path;
                        }
                        else if (0 === _path.indexOf('http://') || 0 === _path.indexOf('https://')) {
                            // Check if the path starts with Docroot and if yes cut it out
                            _internalMethods.getDocroot();
                            if (0 === _path.indexOf(_fullDocroot)) {
                                _path = _path.substr(_fullDocroot.length);
                            }
                        }

                        // Lets do it
                        _tmp = _path.split('/');
                        _path = [];
                        for (var _i in _tmp) {
                            if (_tmp.hasOwnProperty(_i) && '.' !== _tmp[_i] && '' !== _tmp[_i]) {
                                if ('..' === _tmp[_i]) {
                                    _path.pop();
                                }
                                else {
                                    _path.push(_tmp[_i]);
                                }
                            }
                        }
                        _path = _path.join('/');
                        return _path;
                    },
                    'getWindowStyles': function () {
                        var _i, _j, _cssRules, _count, _countJ;
                        _styleSheets = document.styleSheets;
                        _cssString = '';
                        _count = _styleSheets.length;

                        for (_i = 0; _i < _count; _i++) {
                            this.getBase(_styleSheets[_i]);

                            // Don't parse external CSS
                            if (_cssBase !== _fullDocroot) {
                                continue;
                            }

                            if (_styleSheets[_i].cssRules) {
                                _cssRules = _styleSheets[_i].cssRules;
                                _countJ = _cssRules.length;
                                for (_j = 0; _j < _countJ; _j++) {
                                    _cssString += this.fixUrlPathes(_cssRules[_j].cssText);
                                }
                            }
                            else {
                                _cssString += this.fixUrlPathes(_styleSheets[_i].cssText);  // IE8 and earlier
                            }
                        }
                    },
                    'fixUrlPathes': function (_css) {
                        var _url, _i;
                        if (-1 === _css.indexOf('url')) {
                            // no url in the CSS String, there is nothing to do
                            return _css;
                        }
                        _tmp = _css.replace(/url\s*\(\s*["']?([^)]+?)["']?\s*\)/g, function (matching, group1) {
                            return ('url("' + _internalMethods.css.realpath(_cssBase + group1) + '")');
                        });
                        return _tmp;
                    }
                }
            };

        return {
            'getMaxFontsize': function () {
                return _max_fontsize;
            },
            'isMaxFontsizeSet': function () {
                return !!_max_fontsize;
            },
            'getTextarea': function () {
                if (typeof _textarea === 'undefined' || !_textarea.length) {
                    //_textarea = $('textarea[name="message"]');
                    _textarea = document.getElementById('message');
                }
                return _textarea;
            },
            'init': function () {
                this.getTextarea();
                _internalMethods.css.getWindowStyles();
                // Replace all textarea's with SCEditor
                var maxWidth = $('#postingbox').css('width');
                var height = 400;
                if (maxWidth == undefined) {
                    maxWidth = parseInt($('#qr_postform').css('width')) - 30;
                    $('#qr_postform').on('submit', function() {
                        _internalMethods.sourceMode(true);
                    });
                    height = 150;
                } else {
                    maxWidth = parseInt(maxWidth) - 30;
                }

                sceditor.create(_textarea, {
                    format: 'bbcode',
                    plugins: 'autosave',
                    icons: '{EDITOR_BUTTONS_ICONS}',
                    width: maxWidth,
                    toolbar: <!-- IF S_QUICK_REPLY --> '{EDITOR_QUICK_TOOLBAR}' <!-- ELSE --> '{EDITOR_NORMAL_TOOLBAR}' <!-- ENDIF -->,
                    emoticonsRoot: '{U_EMOTICONS_ROOT}',
                    emoticons: { dropdown: sceEmoticonsBBcode },
                    code: sceCodeBBcode,
                    style: '" /><style type="text/css">' + _cssString + '</style><link rel="stylesheet" type="text/css" href="{U_CSS_FIXES}?assets_version={T_ASSETS_VERSION}',
                });

                // Fix the position of the editor layer
                $('#message').hide();
                $('#smiley-box').hide();

                /*
                var scEditorMain = $('.sceditor-container:eq(0)');
                scEditorMain.css('z-index', 1).attr('id', 'sceditor-main-div');
                scEditorMain.find('textarea').attr('id', 'message').attr('name', 'message').addClass('inputbox');
                $('#notification_list').css('z-index', 20);
                //*/

                // Set used nodes (mostly checkboxes)
                _sceInstance = sceditor.instance(_textarea);

                if (height >= 400) {
                    var parser = new sceditor.BBCodeParser();

                    _sceInstance.bind('keyup', function() {
                        if (_sceInstance.inSourceMode()) {
                            _sceInstance.updateOriginal();
                        } else {
                            _sceInstance.setSourceEditorValue(parser.toBBCode(_sceInstance.getWysiwygEditorValue()));
                            _sceInstance.updateOriginal();
                        }
                    });

                    $('input[name="preview"]').on('click', function() {
                        _sceInstance.sourceMode(true);
                    });

                    $('input[name="post"]').on('click', function() {
                        _sceInstance.sourceMode(true);
                    });
                }

                // Initialize the availability of the SCEditor source button
                _internalMethods.sourceButton.init();

                <!-- IF S_BBCODE_ALLOWED -->
                <!-- IF not S_BBCODE_CHECKED eq '' -->
                // BBCode is checked as disallowed, set SCEditor to sourceMode
                _internalMethods.sourceMode(true);
                <!-- ENDIF -->

                // Initialize the onclick event for the BBCode checkbox
                _internalMethods.sourceButton.setOnClick();
                <!-- ELSE -->
                /**
                 * BBCodes are completly disallowed
                 * Hide the sourceButton of SCEditor if visible
                 * and change to sourceMode
                 */

                // TODO fix this for use sourceMode(true) in fast response
                //_internalMethods.sourceButton.hide();
                //_internalMethods.sourceMode(true);
                <!-- ENDIF -->

                // Emoticons part
                <!-- IF S_SMILIES_ALLOWED -->
                _internalMethods.emoticons.init();

                <!-- IF not S_SMILIES_CHECKED eq '' -->
                _sceInstance.emoticons(false);
                <!-- ENDIF -->
                _internalMethods.emoticons.setOnClick();
                <!-- ENDIF -->
            },
            'destroy': function () {
                // Make sure that this is only called
                // when SCEditor is initialized
                if (_sceInstance instanceof Object && _sceInstance.hasOwnProperty('destroy')) {
                    _sceInstance.destroy();
                }
            }
        }
    })(jQuery);
</script>

<!-- INCLUDEJS @dsr_sceditor/js/sce.js -->
<!-- ENDIF -->